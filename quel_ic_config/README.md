# quel_ic_config

## 概要 
adi_api_mod および qubelsi の置き換えと、その機能の抜本的な増強のためのライブラリである。
複数の制御装置を統合するためのシステムソフトウェア開発の障害を解消し、また、将来の拡張性を確保することが開発目的である。
とりあえず使ってみたい場合には、[こちらのドキュメント](./GETTING_STARTED.md)を参照頂きたい。

- QuEL-1のリンク確立、設定状態の取得、簡単な動作試験をするためのコマンド群を提供。
    - `quel1_linkup`:  リンク確立手順を実施する。
    - `quel1_linkstatus`:  現在のリンク状態を表示する。
    - `quel1_dump_port_config`:  各ポートごとの設定状況を表示する。
    - `quel1_firmware_version`: ファームウェアバージョンを表示する。
    - `e7awg_dump`: AWGの内部レジスタをダンプする。(feedback版のファームウェアには未対応。）
- QuEL-1の内部リソースを概念として組織化し、各コンポーネントの設定を容易に行えるAPIを提供。
    - QuelMeeBoardConfigSubsystemクラスの派生クラスとして、制御装置の各モデルを抽象化。
    - オブジェクトの生成は、quel_ic_config_util.create_box_objects() を介して行うこと。
- QuEL-1の筐体にSMAコネクタとして物理的に存在する「ポート」と各種リソース概念を紐付けて管理するレイヤ（SimpleBox) を試験的に提供。
    - SimpleBox は、Configuration Subsystem (css) と Wave Subsystem (wss) の２つのサブシステムを含んでいる。
    - これら2つのサブシステムは、Resource Mapper によって関連付けられた上で、SimpleBoxでポートと紐付けられる。

## 対応制御装置モデル
本ライブラリがサポートしている制御装置モデルの一覧を示す。
ライブラリの初期化時に対象制御装置のモデル名を指定する必要があるので、その識別子も合わせて説明する。

### QuEL-1 (Type-A 及び Type-B)
キュエル株式会社が製造した2022年度から2023年度にかけて製造・販売した制御装置で、 以下の示すとおり、3種類のバリエーションがある。
- 最初期型: 2022年の10月以前に納品した機体。ポート配置がQuBE-RIKENと同じなので、本ライブラリでは　QuBE-RIKEN Type-A と同一視する。 
- 標準型: 2023年2月以降に納品した機体のほとんどすべて。２つの構成 Type-A と Type-B が存在。
- 7GHzモデル： 制御信号の出力帯域が標準型と異なるカスタムタイプ。ソフトウェア的には標準型と等価なので、殆どの場合、QuEL-1 Type-A と同一視できる。

### QuBE (Type-A 及び Type-B)
QuEL-1 の元になった制御装置で、最初期型の QuBE-OU と、その改良型の QuBE-RIKEN とがある。
前者にはモニタ系が実装されていない。後者は　QuEL-1 と同様にモニタ系を内蔵している。
これらのモデルは、キュエル株式会社の納品物ではないが、本ライブラリの動作をサポートする。
後述するように、QuEL-1 とは大幅にポートの並び異なるので注意が必要である。

### モデル識別子一覧
各種コマンド実行時に引数 `--boxtype` で指定する識別子は以下のとおり。
 
- QuEL-1 最初期型: `qube-riken-a`
- QuEL-1 標準型： `quel1-a` または `quel1-b`
- QuEL-1 7GHzモデル： `quel1-a`  (将来的に対応周波数帯域の差をケアするコマンドを実装する際には、`quel1-ntt` を新設する。）
- QuBE-OU: `qube-ou-a` または、`qube-ou-b`
- QuBE-RIKEN:  `qube-riken-a` または、`qube-riken-b`

これら以外の識別子は開発用途のものなので、サポート対象外である。
  
## リソース整理のための言葉づかい
### 送信系
従来ライブラリを初めて触ったときの障害のひとつが、各種リソース間のマッピングがグチャグチャしていることだ。
ドキュメントにちょっとした誤記があったり、コードにもちょっとしたバグがあったり、と何が正しいのか分からないので、
実験して確かめる羽目になったりと、開発速度が上がらない原因のひとつになっている。

そこで、パワーユーザ及び開発者向けに、box, group, line, channel という人間にとって比較的理解しやすい概念を導入する。
これらは、2つの種類の概念、電子回路基板やRTLの設計に由来する各種インデクスと制御装置の筐体の外に出ているSMAコネクタ番号（いわゆるポート番号） との橋渡しをする。
注意するべきは、前者の概念が普通のユーザにとって意識する必要性が薄いのに対し、後者はユーザにとって重要度が高いことだ。
たとえば、10個あるLMX2594に振られた番号や、1つのAD9082が持つ4つDACの番号であるが、そういった詳細なインデクスはパワーユーザであっても常に意識する必要はない。
一方で、それぞれのポートからどの種類の信号が入出力可能で、また、それらを実験コードから参照する方法は、ユーザの重大な関心事である。
したがって、これら２つを直接紐付けても、誰もあまり得をしない。

そこで、導入するのが最初に述べた４つの概念である。
- **box**: 制御装置を指定する識別子
- **group**: なんらかのリソースを共有する、ひとかたまりのDAC/ADCのグループ。
  - QuBE-OU, QuBE-RIKEN, QuEL1 では、groupとMxFE (AD9082) が対応していると考えて問題ない。
  - QuEL1-NEC では、groupと制御対象となる量子ビットと対応が取れる。
- **line**: グループ内の信号経路の識別子。1つのDAC出力ピンあるいは1つのADCの入力ピンに対応する。
  - たとえば、QuBE-OU, QuBE-RIKEN, QuEL1 では、AD9082の4つのDACのそれぞれが Readout, Pump, Ctrl, Ctrl の機能を持つが、AD9082内のDACのハードウェアIDと機能のマッピングは単純ではない。line はこのマッピングを分かりやすくするために導入された。
- **channel**: 1つのDAC及びADCが複数個持つ得るチャネルと対応する。ICは全てのチャネルを通し番号で管理するが、ユーザにとっては、各line内で閉じたインデクスで参照する方が便利なので、番号を振り直すのに用いる。この概念は、FPGA内のAWG Unit及びCapture Moduleのインデクスとも対応する。

#### 例：QuEL-1 Type-A の場合
前半ポート（0から6)が グループ0、後半ポート（7から13)が グループ1 に対応している。
各グループは4つのDACライン（0から3）と2つのADCライン（0と1）を持つ。
４つのDACラインは、0がRead-out, 1がPump, 2がひとつめのCtrl, 3がふたつめのCtrlに対応する。
２つのADCラインは、0がRead-in, 1がMonitor-in に対応する。
簡単のために番号で呼んでいるが、適切な名前を付けるともっと便利になるだろう。

| MxFEの番号 | DAC番号 | (group, line)　 | ポート番号 | 機能 |
|-----------|--------|----------------|-------|------|
| 0       | 0     | (0, 0)         | 1     | Read-out |
| 0       | 1     | (0, 1)         | 3     | Pump |
| 0       | 2     | (0, 2)         | 2     | Ctrl |
| 0       | 3     | (0, 3)         | 4     | Ctrl |
| 1       | 3     | (1, 0)         | 8     | Read-out |
| 1       | 2     | (1, 1)         | 10    | Pump |
| 1       | 1     | (1, 2)         | 11    | Ctrl |
| 1       | 0     | (1, 3)         | 9     | Ctrl |

歴史的経緯などで、リソースのマッピングが非常に複雑なことになっている。
これにチャネルとかAWGとかがad hocにアサインされているのが組み合わさるとどうなるか、想像に難くないだろう。
このライブラリはユニットテストで、上記のものを含む全てのリソースマッピングについて、テストコードを走らせてテストする方針なので、
参照文献としても有用なものになるだろう。

#### 例：Quel-1 Type-B の場合
Type-A では、コントロールポート間のクロストークの予防策として、同じグループの2つのコントロールポートが物理的に隣接しないようなポート配置
をしていたが、Type-Bでは、全ての出力ポートがコントロールポートなので、そのような予防策を行う余地がない。
そうであっても Type-A と同じポート配置にしておくという選択はあったのだが、実際には、内部の配線が自然な状態に近くなるようなポート配置になっている。
この差異は、想像以上に頭がこんがらがるので、group, line という概念が必要になった大きい理由のひとつになってる。

なにはともあれ、次の表のような結線になっている。

| MxFEの番号 | DAC番号 | (group, line)　 | ポート番号 | 機能   |
|-----------|--------|----------------|-------|------|
| 0       | 0     | (0, 0)         | 1     | Ctrl |
| 0       | 1     | (0, 1)         | 2     | Ctrl |
| 0       | 2     | (0, 2)         | 3     | Ctrl |
| 0       | 3     | (0, 3)         | 4     | Ctrl |
| 1       | 3     | (1, 0)         | 8     | Ctrl |
| 1       | 2     | (1, 1)         | 9     | Ctrl |
| 1       | 1     | (1, 2)         | 11    | Ctrl |
| 1       | 0     | (1, 3)         | 10    | Ctrl |


#### 例: QuBE の場合
QuBEはQuEL-1の元になった制御装置であり、最初型（QuBE-OU）とその改良版（QuBE-RIKEN）の2つのモデルがある。
表面的には、QuBE-OUにはモニタ系が無く、それにモニタ系を追加したのがQuBE-RIKENである。
それぞれ、2つの構成の装置、Type-AとType-B があり、先述のQuEL-1のType-AとType-Bにも踏襲している。

QuEL-1 とはポートの並びが大きく異なることに注意が必要である。

| MxFEの番号 | DAC番号 | (group, line)　 | ポート番号 | Type-A機能 | Type-B 機能 |
|-----------|--------|----------------|-------|----------|-----------|
| 0       | 0     | (0, 0)         | 0     | Read-out | Ctrl      |
| 0       | 1     | (0, 1)         | 2     | Pump     | Ctrl      |
| 0       | 2     | (0, 2)         | 5     | Ctrl     | Ctrl      |
| 0       | 3     | (0, 3)         | 6     | Ctrl     | Ctrl      |
| 1       | 3     | (1, 0)         | 13    | Read-out | Ctrl      |
| 1       | 2     | (1, 1)         | 11    | Pump     | Ctrl      |
| 1       | 1     | (1, 2)         | 8     | Ctrl     | Ctrl      |
| 1       | 0     | (1, 3)         | 7     | Ctrl     | Ctrl      |

#### 今後の方向性
quel_ic_config はAD9082の設定変更を積極的に行える枠組みも提供する。
なので、上記の歴史を引きずった不規則なリソースアサインの整理を安全に行うことができるようになるだろう。
すでにリリース済みの機種については、変更をしないつもりだが、今後の機種についてはリリース前にリソースマッピングを
整理することにしたい。


### 受信系
受信系のリソースも正確に理解するのが難しい。
ハードウェア及びファームウェアでのリソースの考え方が発展途上にあるので、将来の拡張を妨げない概念形成が求められていること相まって、事態は複雑である。
いずれにしても、送信系と同様に、パワーユーザ向けに次のような階層的概念を導入する。
box, group までは共通なので、それよりも細かい概念を説明する。

- **rline**: アナログ信号経路の識別子。つまり、ADCのポートに紐付けられる。
- **runit**: rline内に複数あるいくつかの信号処理経路の識別子。同じ　rline 内の runit は同じアナログをADCしたデータストリームを受け取るが、途中のフィルタ、ダウンコンバータ、各種DSPの設定に依存して異なる出力を生成する。

量子計算機の言葉で言えば、rline は基本的に同じ読み出し信号によって反射測定される量子ビットクラスタと対応し、runit がそのクラスタ内の各量子ビットに対応する。

#### rlineについて
各グループは、リード系(`r`)とモニタ系(`m`)の２つの rline をもつ。
設計意図としては、リード系が量子ビットの反射測定用の系で、モニタ系が装置自体が生成した信号をループバックで監視するための系である。
これら2つのrlineは、FPGAの手前までは独立したハードウェアリソースによって実現されているが、現在の広まっているファームウェア(simple_multi) では、
FPGAの入り口でどちらか一方が選択されて、共通のキャプチャモジュールへ接続する。
この「切り替え」の機能は順次廃止される予定である。
具体的には、リード系が現状のキャプチャモジュールを専有し、モニタ系用に簡易版のキャプチャモジュールを新設することになる予定だ。
これを先取りして概念を整理すると、 基本的にひとつのrlineはひとつのキャプチャモジュールに紐づく、と考えてよい。
逆が成り立たないことに気をつければ、この言明は現状のファームウェアでも正しい。

#### runitの実現について
runit は QuEL-1のAD9082のADCのチャネライザとFPGA内のDSPモジュールによって実現される機能を抽象化した概念である。
runitとDSPモジュールの間には一対一の対応関係が成り立つが、runitとチャネライザとの間は必ずしも成り立たない。
例えば、現状の simple_multi ファームウェアでは、同じ rline内の全てのrunit（あるいは「同じcapture module内のcapture unit」と言い換えてもよい）
が、ひとつのチャネライザを共有している。

この単一チャネライザ構成は、共通の読み出し信号でカバーされる各量子ビットの読み出し共振器の共振周波数が、ひとつのチャネライザの帯域内に収まっている前提の設計である。
この制限を緩和したい場合には、複数のチャネライザを割り当ればよいが、単一チャネライザ構成とrunitとチャネライザを一対一とする構成との間に、いくつかの中間的な構成が可能である。
可能性な概念化として、rline - チャネライザ - runit という3層構造があるが、これは不採用とした。
つまり、runit は個々の割り付け方式と独立した概念とし、runitとチャネライザとの対応関係はrunitの属性として管理する方が、使いやすいと考えた。
実際には「中間的な割り付け」は可能な限り避けることになるはずで、そのような可能性のためにリソースの概念を複雑化するのを嫌った、ということでもある。

| ポート番号 | 受信LO番号 | MxFEの番号 | ADC番号, CNCO番号, FNCO番号 | (group, rline, runit)　 | キャプチャモジュール | キャプチャユニット |
|----|---|---|---------|------------------------|----|---|
| 0  | 0 | 0 | 3, 3, 5 | (0, r, 0)              | 1  | 4 |
| 0  | 0 | 0 | 3, 3, 5 | (0, r, 1)              | 1  | 5 |
| 0  | 0 | 0 | 3, 3, 5 | (0, r, 2)              | 1  | 6 |
| 0  | 0 | 0 | 3, 3, 5 | (0, r, 3)              | 1  | 7 |
| 5  | 1 | 0 | 2, 2, 4 | (0, m, 0)              | 1  | 4 |
| 5  | 1 | 0 | 2, 2, 4 | (0, m, 1)              | 1  | 5 |
| 5  | 1 | 0 | 2, 2, 4 | (0, m, 2)              | 1  | 6 |
| 5  | 1 | 0 | 2, 2, 4 | (0, m, 3)              | 1  | 7 |
| 7  | 7 | 1 | 3, 3, 5 | (0, r, 0)              | 0  | 0 |
| 7  | 7 | 1 | 3, 3, 5 | (0, r, 1)              | 0  | 1 |
| 7  | 7 | 1 | 3, 3, 5 | (0, r, 2)              | 0  | 2 |
| 7  | 7 | 1 | 3, 3, 5 | (0, r, 3)              | 0  | 3 |
| 12 | 6 | 1 | 2, 2, 4 | (0, m, 0)              | 0  | 0 |
| 12 | 6 | 1 | 2, 2, 4 | (0, m, 1)              | 0  | 1 |
| 12 | 6 | 1 | 2, 2, 4 | (0, m, 2)              | 0  | 2 |
| 12 | 6 | 1 | 2, 2, 4 | (0, m, 3)              | 0  | 3 |

#### feedbackファームウェア / 2024年2月以降のsimplemultiファームウェアの場合
feedback版のファームウェア及び2024年2月以降にリリース予定のsimplemulti版のファームウェアでは、リード系とモニタ系を同時に使用できる。
これらのファームウェアは新たに2つのキャプチャモジュールを実装しており、下表に示すようにモニタ系と紐づいている。
新しいキャプチャモジュールにはDSP機能が省かれており、複数の量子ビットの多重化読み出しのハードウェアサポートを提供しない。
モニタ系という用途に限定すれば、これは全く問題にならないだろう。

| ポート番号 | 受信LO番号 | MxFEの番号 | ADC番号, CNCO番号, FNCO番号 | (group, rline, runit)　 | キャプチャモジュール | キャプチャユニット |
|----|---|---------|----------|------------------------|----|----|
| 0  | 0 | 0       | 3, 3, 5  | (0, r, 0)              | 1  | 4  |
| 0  | 0 | 0       | 3, 3, 5  | (0, r, 1)              | 1  | 5  |
| 0  | 0 | 0       | 3, 3, 5  | (0, r, 2)              | 1  | 6  |
| 0  | 0 | 0       | 3, 3, 5  | (0, r, 3)              | 1  | 7  |
| 5  | 1 | 0       | 2, 2, 4  | (0, m, 0)              | 3  | 9  |
| 7  | 7 | 1       | 3, 3, 5  | (1, r, 0)              | 0  | 0  |
| 7  | 7 | 1       | 3, 3, 5  | (1, r, 1)              | 0  | 1  |
| 7  | 7 | 1       | 3, 3, 5  | (1, r, 2)              | 0  | 2  |
| 7  | 7 | 1       | 3, 3, 5  | (1, r, 3)              | 0  | 3  |
| 12 | 6 | 1       | 2, 2, 4  | (1, m, 0)              | 2  | 8  |
