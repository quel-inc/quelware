# quel_ic_config

## 概要 
adi_api_mod および qubelsi の置き換えと、その機能の抜本的な増強のためのライブラリである。
複数の制御装置を統合するためのシステムソフトウェア開発の障害を解消し、また、将来の拡張性を確保することが開発目的である。

### 初期設定のコードからの分離
各世代および各タイプの制御装置ごとに、各種ICのレジスタの初期値をコードからなるべく独立して持てるようにした。
製品出荷時に標準の初期設定を付属するが、ユーザはオリジナルの初期値を作成することもできる。この際にコードを修正せずに済むのは
好ましい性質だ。

### ライブラリ開発の効率化
型ヒントとユニットテストが整備されており、また、関連する実装がコードの字面上で局在するように設計しているので、
機能追加によって予想外のパンチを食らう可能性をかなり低減できている。
従来のように、Cで記述した実行ファイルを呼び出すようなこともないので、異常の検出も容易になっている。


## リソース整理のための言葉づかい
従来ライブラリを初めて触ったときの障害のひとつが、各種リソース間のマッピングがグチャグチャしていることだ。
ドキュメントにちょっとした誤記があったり、コードにもちょっとしたバグがあったり、と何が正しいのか分からないので、
実験して確かめる羽目になったりと、開発速度が上がらない原因のひとつになっている。

そこで、パワーユーザ及び開発者向けに、box, group, line, channel という人間にとって比較的理解しやすい概念を導入する。
これらは、2つの種類の概念、電子回路基板やRTLの設計に由来する各種インデクスと制御装置の筐体の外に出ているSMAコネクタ番号（いわゆるポート番号） との橋渡しをする。
注意するべきは、前者の概念が普通のユーザにとって意識する必要性が薄いのに対し、後者はユーザにとって重要度が高いことだ。
たとえば、10個あるLMX2594に振られた番号や、1つのAD9082が持つ4つDACの番号であるが、そういった詳細なインデクスはパワーユーザであっても常に意識する必要はない。
一方で、それぞれのポートからどの種類の信号が入出力可能で、また、それらを実験コードから参照する方法は、ユーザの重大な関心事である。
したがって、これら２つを直接紐付けても、誰もあまり得をしない。

そこで、導入するのが最初に述べた４つの概念である。
- **box**: 制御装置を指定する識別子
- **group**: なんらかのリソースを共有する、ひとかたまりのDAC/ADCのグループ。現状は、同じMxFEに属するDAC/ADCのグループなので、AD9082の番号に紐づいていると考えて良い。
- **line**: グループ内の信号経路の識別子。単位的には1つのDAC出力ピンあるいは1つのADCに対応する。たとえば、AD9082は4つのDACをもち、それぞれが Readout, Pump, Ctrl, Ctrl の機能を持つ。これらの機能とDACの番号との対応が必ずしも人間に分かりやすないので、緩衝レイヤとして導入する。
- **channel**: 1つのDAC及びADCが複数個持つ得るチャネルと対応する。ICは全てのチャネルを通し番号で管理するが、ユーザにとっては、各line内で閉じたインデクスで参照する方が便利なので、番号を振り直すのに用いる。この概念は、FPGA内のAWG Unit及びCapture Moduleのインデクスとも対応する。

### 例：QuEL-1 Type-A の場合
前半ポート（0から6)が グループ0、後半ポート（7から13)が グループ1 に対応している。
各グループは4つのDACライン（0から3）と2つのADCライン（0と1）を持つ。
４つのDACラインは、0がRead-out, 1がPump, 2がひとつめのCtrl, 3がふたつめのCtrlに対応する。
２つのADCラインは、0がRead-in, 1がMonitor-in に対応する。
簡単のために番号で呼んでいるが、適切な名前を付けるともっと便利になるだろう。

| MxFEの番号 | DAC番号 | (グループ, ライン)　 | ポート番号 | 機能 |
|-----------|--------|-------------------|-------|------|
| 0       | 0     | (0, 0) | 1     | Read-out |
| 0       | 1     | (0, 1) | 3     | Pump |
| 0       | 2     | (0, 2) | 2     | Ctrl |
| 0       | 3     | (0, 3) | 4     | Ctrl |
| 1       | 3     | (1, 0) | 8     | Read-out |
| 1       | 2     | (1, 1) | 10    | Pump |
| 1       | 1     | (1, 2) | 11    | Ctrl |
| 1       | 0     | (1, 3) | 9     | Ctrl |

歴史的経緯などで、リソースのマッピングが非常に複雑なことになっている。
これにチャネルとかAWGとかがad hocにアサインされているのが組み合わさるとどうなるか、想像に難くないだろう。
このライブラリはユニットテストで、上記のものを含む全てのリソースマッピングについて、テストコードを走らせてテストする方針なので、
参照文献としても有用なものになるだろう。

### 例：Quel-1 Type-B の場合
Type-A では、コントロールポート間のクロストークの予防策として、同じグループの2つのコントロールポートが物理的に隣接しないようなポート配置
をしていたが、Type-Bでは、全ての出力ポートがコントロールポートなので、そのような予防策を行う余地がない。
そうであっても Type-A と同じポート配置にしておくという選択はあったのだが、実際には、内部の配線が自然な状態に近くなるようなポート配置になっている。
この差異は、想像以上に頭がこんがらがるので、group, line という概念が必要になった大きい理由のひとつになってる。

なにはともあれ、次の表のような結線になっている。

| MxFEの番号 | DAC番号 | (グループ, ライン)　 | ポート番号 | 機能   |
|-----------|--------|-------------------|-------|------|
| 0       | 0     | (0, 0) | 1     | Ctrl |
| 0       | 1     | (0, 1) | 2     | Ctrl |
| 0       | 2     | (0, 2) | 3     | Ctrl |
| 0       | 3     | (0, 3) | 4     | Ctrl |
| 1       | 3     | (1, 0) | 8     | Ctrl |
| 1       | 2     | (1, 1) | 9     | Ctrl |
| 1       | 1     | (1, 2) | 11    | Ctrl |
| 1       | 0     | (1, 3) | 10    | Ctrl |

### 今後の方向性
quel_ic_config はAD9082の設定変更を積極的に行える枠組みも提供する。
なので、上記の歴史を引きずった不規則なリソースアサインの整理を安全に行うことができるようになるだろう。
すでにリリース済みの機種については、変更をしないつもりだが、今後の機種についてはリリース前にリソースマッピングを
整理することにしたい。

### 注意など
このライブラリは「ポート」の概念とは密な結合を避ける方針である。
したがって、ラインとポートのマッピングは、基本的に上位レイヤで扱うこととする。
ただし、デジタルコンバインなどで、複数のラインを統合して、1つのポートから出すケースの扱いには注意が必要だ。
コンバイン用の設定をするのはこのレイヤなので、上位レイヤとの連携について、注意深い設計が必要になるだろう。

## テストについて
testlibs 以下にテスト用のクラス群を定義している。
これらのクラスでは、クラスやメソッドが典型的な実行順序を示す番号で管理しているが、これはユーザ用のライブラリ設計には引き継がない。
いきなり話が逸れるが、testlibs の開発過程で決定した操作の粒度を参考に、ユーザが分かりやすく、かつ、やりたいことのほとんどが簡単にできる抽象化レイヤを設計するつもりだ。

tests の中にはユニットテストがある。
これらのテストは実デバイスに依存せずに実行可能である。
各クラスの仕様を理解する上でも重要な情報を含んでいるので、ドキュメントにない情報を知る必要があるときは、コードを読む前にこちらを参照するべだ。

tests_with_devices の中には、実デバイスを使用した結合テストが含まれている。
これらのテストケースを通じて、ライブラリが実機で意図通りに動作することを保証している。
こちらも、設計資料として重要な情報を含んでいる。
特に実デバイスの構成について、確実に検証済みの情報が得られるのは、今のところ、ここだけだ。

## 使ってみる
次のコマンドで、指定の制御装置をリンクアップして、任意のAPIを叩く準備をできる。
```shell
PYTHONPATH=. python -i testlibs/basic_scan_common.py --ipaddr_css 10.5.0.42 --ipaddr_wss 10.1.0.42 --ipaddr_sss 10.2.0.42 --boxtype quel1-a --mxfe both 
```

