# ファームウェア書き込みなどのためのツール群

QuEL-1 を及びその後継機のファームウェア書き込みを誰でもできるようにするのが目的です。
使いようによっては様々事故を引き起こし得るので、細心の注意を払ってご使用くださいませ。

## インストール
```bash
python -m build
pip install dist/quel_staging_tool-x.y.z-py3-none-any.whl
```

また、ファームウェアのイメージは別途ダウンロードが必要です。
詳しくは [quel-firmwares](https://github.com/quel-inc/quel-firmwares) を参照してください。

## 準備
以下のコマンドを実行するシェルでは、次のコマンドを実行して、Vivadoのパスを通しておく必要がある。
```
source /tools/Xilinx/Vivado/2020.1/settings64.sh
```

## Alveo U50 (QuEL-1 及び QuEL-1 SE) 
### ファームウェア書き込み
`quel_program_au50` コマンドを使用する。
以下の例は、アダプタID 500202A50xxxA に繋がっているFPGA(Alveo U50)に、simplemulti_20230820 のバージョンの
ファームウェアを書き込む。この際に、MACアドレスを`00-0a-35-16-66-48`、IPアドレスを`10.1.0.250` に設定する。

```bash
quel_program_au50 --adapter 500202A50xxxA --macaddr 00-0a-35-16-66-48 --ipaddr 10.1.0.250 --firmware simplemulti_20230820 --port 3121
```

- アダプタIDは、アダプタに貼ってあるシールに記載されている。xsdb コマンドでhw_managerに接続されているアダプタIDの一覧を見ることもできる。
- MACアドレスは、Alveo U50 に貼ってあるシールに記載のものを使用する。
- IPアドレスは、MACアドレスと紐づけてた値を社内で管理しているので、それを利用する。
- ファームウェアバージョンは、このパッケージに含まれているものから選ぶ必要がある。 `--help` オプションで可能な選択肢を表示できる。新たなバージョンのファームウェアのパッケージへの追加については、別の文書で説明する予定。

指定のMACアドレスとIPアドレスとは、AのケーブルのI/Fに反映される。
QuEL-1 は BのケーブルのI/Fも有効化されるが、そのMACアドレスとIPアドレスは次のルールで決定する。
- MACアドレスは 1LSB足す。ただし、OUI（上位24bit）に桁上りが発生した場合には、エラーが発生する。
- IPアドレスは、第２オクテットに1を足す。上記例であれば、10.2.0.250 となる。


### リブート
アダプタがPCのUSBコネクタに繋がっていると、FPGAが起動しない場合がある。
その場合には、アダプタIDを指定して次のコマンドを実行することで、起動することができる。

```bash
quel_reboot_fpga --adapter 500202A50xxxA
```

このコマンドを起動すると、アダプタの電源がオフになるまでは、QuEL-1本体のパワーサイクルをした際にFPGAが起動するようになる。
アダプタの電源は、USBケーブル経由で供給されるので、USBケーブルを抜かない限りはこのコマンドを実行しなくても、FPGAは何もしなくても起動する。
実際には、USBケーブルを抜いても、ある程度の時間はアダプタ内に情報が残っているようだ。

また、FPGAがフリーズした場合には、このコマンドで復帰できることが多い。

なお、`quel_program_au50`コマンドは、mcsファイルを書き込んだ場合には、書き込み終了後に自動的にrebootを実行する。

## ExStickGE (QuEL-1 及び QuEL-1 SE)

### ファームウェア書き込み

#### QuEL-1 用のファームウェア
`quel_program_exstickge_1` コマンドを使用する。使い方は、AlveoU50 と同じ。
Vivado 2020.1 と一緒に用いる。

#### QuEL-1 SE用のファームウェア
`quel_program_exstickge_1se` コマンドを使用する。
Vivado/Vitis 2022.1 と一緒に用いる。

#### クロック分配器用のファームウェア
`quel_program_exstickge_clkdisty` コマンドを使用する。
Vivado/Vitis 2022.1 と一緒に用いる。

### リブート
`quel_reboot_fpga` コマンドを使用できる。

## Alveo U200 (Clock Master)
### ファームウェア書き込み
クロックマスターのファームウェアのフラッシュには　`quel_program_au200` コマンドを使用する。
使い方は、AlveoU50 と同じ。
Vivado 2020.1 と一緒に用いる。

### リブート
`quel_reboot_fpga` コマンドを使用できる。


## 高度な機能について
ここで紹介する機能は、QuEL-1及びQuEL-1 SEのメンテナンス業務を大きく省力化できる反面、xsdb 及び hwserver の詳細を理解していないと使いこなすことが難しいので注意が必要である。
これは、Xilinxの補助ツール群のインターフェースの設計上の問題に起因する。
つまり、なんらかの異常が発生したときに、腑に落ちる説明にたどり着くためにはXilinxの補助ツール群のそこそこ詳細な挙動を理解する必要がある。
たとえば、次のようなケースに何が起こるのか、把握してから使っていただきたい。
- 既にhw_serverが握っているアダプタを、新しく起動したhw_serverが握ろうとした場合に、古いhw_serverは未来永劫アダプタを握れなくなること
- ツールやサーバの起動のタイミングで、依存するサーバが見つからない場合に、それらを自動で立ち上げようとすること
  - 同じ依存サーバを持つ2つのサーバを同時に起動しようとすると、既に依存サーバが起動していない場合には、依存サーバの自動起動に失敗するが故に、全てが失敗に終わる(!)
- 一部のサーバを始末するのにシグナルを送るしか方法がないことと、それに対してXilinxが用意した代案がアクセスが途切れたら時限的に終了するオプションであること

### リモート書き込み
書き込み対象のQuEL-1のアダプタがつながっているPCとは別のPCから、ネットワーク越しに書き込みを行うことができる。
ただし、アダプタがつなっているPC上でハードウェアサーバを予め起動しておく必要がある。
`quel_pyxsdb` の `service_example`ディレクトリには、xsdbサーバをsystemdのサービスとして立ち上げるサンプルがあるので、参考にしていただきたい。
たとえば、`xsdb-au50.service` は、ハードウェアサーバのデフォルトの3121番ポートに Vivado 2020.1 のハードウェアサーバを常時立ち上げる。

アダプタがつながっているPCのIPアドレスが192.168.1.10であった場合、次のコマンドでファームウェアのリモート書き込みが可能である。
```bash
quel_program_au50 --adapter 500202A50xxxA --macaddr 00-0a-35-16-66-48 --ipaddr 10.1.0.250 --firmware simplemulti_20230820 --host 192.168.1.10 --port 3121
```
なお、`--host` と `--port` 以外のパラメタは、上述の例と同じ値にしておいた。

### 並列書き込み
QuEL-1 および QuEL-1 SE のファームウェア書き込みには一台あたり20分〜30分程度の時間がかかる。
これを逐次的に書き込むのはできればやりたくない仕事であるはずだ。
一般的な使用状況では、hw_serverはPCにひとつだけ起動しており、全てのアダプタを握っている。
そして、hw_serverは全ての操作を逐次的に行うので、世界に不幸の種が1つ増える。

これを避ける機能を `quel_program_au50` コマンドに用意した。
`--host localhost --port 0` を指定すると、`--adapter` で指定したアダプタだけを握る hw_server を自動的に起動し、並列書き込みができる。

ただし、2つほど注意点がある。
まず、既に 別のhw_server が起動していて指定のアダプタを握っている場合、そのhw_serverは未来永劫、指定したアダプタへのアクセスができなくなる。
したがって、指定のアダプタを握っている hw_server が存在しない状況だけでこの機能を使うべきだ。
次に、`quel_program_au50` をスクリプトなどで複数立ち上げる場合には、ひとつめとふたつめの起動を数秒空けることをお勧めする。
hw_server は cs_server に依存していて、cs_server が存在しない場合にデフォルトの3042番ポートにこのサーバを起動しようとする。
2つのhw_serverが 同時に3042番ポートにcs_severを立ち上げようとするので、悲しい事故が起こってしまう。
あらかじめ cs_server を上げておくことで回避することも可能だが、スクリプト内で起動した cs_server をスクリプトの最後で事故を起こさずに始末するのはすごく面倒なのでお勧めしない。

なお、並列リモート書き込みには対応していない。
要望があれば考えるが、hw_server_server を実装することになるだろう。
この手法は、cs_server の問題を回避をする余地ができるなど、いろいろ利点があるのだが、ひとことで優先度は高くないと考えている。
