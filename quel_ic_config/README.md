# quel_ic_config

## 概要 
adi_api_mod および qubelsi の置き換えと、その機能の抜本的な増強のためのライブラリである。
複数の制御装置を統合するためのシステムソフトウェア開発の障害を解消し、また、将来の拡張性を確保することが開発目的である。

- QuEL-1内部リソースを分かりやすく組織化し、各コンポーネントの設定を容易に行えるAPIを提供。
    - 詳細は「リソース整理のための言葉づかい」を参照のこと。
- QuEL-1のリンク確立、設定状態の取得、簡単な動作試験をするためのコマンド群を提供。
    - `quel1_linkup`:  リンク確立手順を実施する。
    - `quel1_linkstatus`:  現在のリンク状態を表示する。
    - `quel1_dump_port_config`:  各ポートごとの設定状況を表示する。

## リソース整理のための言葉づかい
### 送信系
従来ライブラリを初めて触ったときの障害のひとつが、各種リソース間のマッピングがグチャグチャしていることだ。
ドキュメントにちょっとした誤記があったり、コードにもちょっとしたバグがあったり、と何が正しいのか分からないので、
実験して確かめる羽目になったりと、開発速度が上がらない原因のひとつになっている。

そこで、パワーユーザ及び開発者向けに、box, group, line, channel という人間にとって比較的理解しやすい概念を導入する。
これらは、2つの種類の概念、電子回路基板やRTLの設計に由来する各種インデクスと制御装置の筐体の外に出ているSMAコネクタ番号（いわゆるポート番号） との橋渡しをする。
注意するべきは、前者の概念が普通のユーザにとって意識する必要性が薄いのに対し、後者はユーザにとって重要度が高いことだ。
たとえば、10個あるLMX2594に振られた番号や、1つのAD9082が持つ4つDACの番号であるが、そういった詳細なインデクスはパワーユーザであっても常に意識する必要はない。
一方で、それぞれのポートからどの種類の信号が入出力可能で、また、それらを実験コードから参照する方法は、ユーザの重大な関心事である。
したがって、これら２つを直接紐付けても、誰もあまり得をしない。

そこで、導入するのが最初に述べた４つの概念である。
- **box**: 制御装置を指定する識別子
- **group**: なんらかのリソースを共有する、ひとかたまりのDAC/ADCのグループ。現状は、同じMxFEに属するDAC/ADCのグループなので、AD9082の番号に紐づいていると考えて良い。
- **line**: グループ内の信号経路の識別子。単位的には1つのDAC出力ピンあるいは1つのADCに対応する。たとえば、AD9082は4つのDACをもち、それぞれが Readout, Pump, Ctrl, Ctrl の機能を持つ。これらの機能とDACの番号との対応が必ずしも人間に分かりやすないので、緩衝レイヤとして導入する。
- **channel**: 1つのDAC及びADCが複数個持つ得るチャネルと対応する。ICは全てのチャネルを通し番号で管理するが、ユーザにとっては、各line内で閉じたインデクスで参照する方が便利なので、番号を振り直すのに用いる。この概念は、FPGA内のAWG Unit及びCapture Moduleのインデクスとも対応する。

#### 例：QuEL-1 Type-A の場合
前半ポート（0から6)が グループ0、後半ポート（7から13)が グループ1 に対応している。
各グループは4つのDACライン（0から3）と2つのADCライン（0と1）を持つ。
４つのDACラインは、0がRead-out, 1がPump, 2がひとつめのCtrl, 3がふたつめのCtrlに対応する。
２つのADCラインは、0がRead-in, 1がMonitor-in に対応する。
簡単のために番号で呼んでいるが、適切な名前を付けるともっと便利になるだろう。

| MxFEの番号 | DAC番号 | (group, line)　 | ポート番号 | 機能 |
|-----------|--------|----------------|-------|------|
| 0       | 0     | (0, 0)         | 1     | Read-out |
| 0       | 1     | (0, 1)         | 3     | Pump |
| 0       | 2     | (0, 2)         | 2     | Ctrl |
| 0       | 3     | (0, 3)         | 4     | Ctrl |
| 1       | 3     | (1, 0)         | 8     | Read-out |
| 1       | 2     | (1, 1)         | 10    | Pump |
| 1       | 1     | (1, 2)         | 11    | Ctrl |
| 1       | 0     | (1, 3)         | 9     | Ctrl |

歴史的経緯などで、リソースのマッピングが非常に複雑なことになっている。
これにチャネルとかAWGとかがad hocにアサインされているのが組み合わさるとどうなるか、想像に難くないだろう。
このライブラリはユニットテストで、上記のものを含む全てのリソースマッピングについて、テストコードを走らせてテストする方針なので、
参照文献としても有用なものになるだろう。

#### 例：Quel-1 Type-B の場合
Type-A では、コントロールポート間のクロストークの予防策として、同じグループの2つのコントロールポートが物理的に隣接しないようなポート配置
をしていたが、Type-Bでは、全ての出力ポートがコントロールポートなので、そのような予防策を行う余地がない。
そうであっても Type-A と同じポート配置にしておくという選択はあったのだが、実際には、内部の配線が自然な状態に近くなるようなポート配置になっている。
この差異は、想像以上に頭がこんがらがるので、group, line という概念が必要になった大きい理由のひとつになってる。

なにはともあれ、次の表のような結線になっている。

| MxFEの番号 | DAC番号 | (group, line)　 | ポート番号 | 機能   |
|-----------|--------|----------------|-------|------|
| 0       | 0     | (0, 0)         | 1     | Ctrl |
| 0       | 1     | (0, 1)         | 2     | Ctrl |
| 0       | 2     | (0, 2)         | 3     | Ctrl |
| 0       | 3     | (0, 3)         | 4     | Ctrl |
| 1       | 3     | (1, 0)         | 8     | Ctrl |
| 1       | 2     | (1, 1)         | 9     | Ctrl |
| 1       | 1     | (1, 2)         | 11    | Ctrl |
| 1       | 0     | (1, 3)         | 10    | Ctrl |

#### 今後の方向性
quel_ic_config はAD9082の設定変更を積極的に行える枠組みも提供する。
なので、上記の歴史を引きずった不規則なリソースアサインの整理を安全に行うことができるようになるだろう。
すでにリリース済みの機種については、変更をしないつもりだが、今後の機種についてはリリース前にリソースマッピングを
整理することにしたい。

#### 例: Quel-1 SE の場合
AD9082近辺の大まかな回路パターンの構造はQuEL-1から踏襲しているが、ミキサボードがグループごとに分割され、かつ、両グループで共通のボート
となるので、CDUCとFDUCのマッピングの仕方などを弄る必要がありそうだ。ここらへんも、settings 以下にある設定ファイルで調整可能なので、特に
問題にはならない。

#### 注意など
このライブラリは「ポート」の概念とは密な結合を避ける方針である。
したがって、ラインとポートのマッピングは、基本的に上位レイヤで扱うこととする。
ただし、デジタルコンバインなどで、複数のラインを統合して、1つのポートから出すケースの扱いには注意が必要だ。
コンバイン用の設定をするのはこのレイヤなので、上位レイヤとの連携について、注意深い設計が必要になるだろう。

### 受信系
受信系のリソースも正確に理解するのが難しい。
ハードウェア及びファームウェアでのリソースの考え方が発展途上にあるので、将来の拡張を妨げない概念形成が求められていること相まって、事態は複雑である。
いずれにしても、送信系と同様に、パワーユーザ向けに次のような階層的概念を導入する。
box, group までは共通なので、それよりも細かい概念を説明する。

- **rline**: アナログ信号経路の識別子。つまり、ADCのポートに紐付けられる。
- **runit**: rline内に複数あるいくつかの信号処理経路の識別子。同じ　rline 内の runit は同じアナログをADCしたデータストリームを受け取るが、途中のフィルタ、ダウンコンバータ、各種DSPの設定に依存して異なる出力を生成する。

量子計算機の言葉で言えば、rline は基本的に同じ読み出し信号によって反射測定される量子ビットクラスタと対応し、runit がそのクラスタ内の各量子ビットに対応する。

#### rlineについて
各グループは、リード系(`r`)とモニタ系(`m`)の２つの rline をもつ。
設計意図としては、リード系が量子ビットの反射測定用の系で、モニタ系が装置自体が生成した信号をループバックで監視するための系である。
これら2つのrlineは、FPGAの手前までは独立したハードウェアリソースによって実現されているが、現在の広まっているファームウェア(simple_multi) では、
FPGAの入り口でどちらか一方が選択されて、共通のキャプチャモジュールへ接続する。
この「切り替え」の機能は順次廃止される予定である。
具体的には、リード系が現状のキャプチャモジュールを専有し、モニタ系用に簡易版のキャプチャモジュールを新設することになる予定だ。
これを先取りして概念を整理すると、 基本的にひとつのrlineはひとつのキャプチャモジュールに紐づく、と考えてよい。
逆が成り立たないことに気をつければ、この言明は現状のファームウェアでも正しい。

#### runitの実現について
runit は QuEL-1のAD9082のADCのチャネライザとFPGA内のDSPモジュールによって実現される機能を抽象化した概念である。
runitとDSPモジュールの間には一対一の対応関係が成り立つが、runitとチャネライザとの間は必ずしも成り立たない。
例えば、現状の simple_multi ファームウェアでは、同じ rline内の全てのrunit（あるいは「同じcapture module内のcapture unit」と言い換えてもよい）
が、ひとつのチャネライザを共有している。

この単一チャネライザ構成は、共通の読み出し信号でカバーされる各量子ビットの読み出し共振器の共振周波数が、ひとつのチャネライザの帯域内に収まっている前提の設計である。
この制限を緩和したい場合には、複数のチャネライザを割り当ればよいが、単一チャネライザ構成とrunitとチャネライザを一対一とする構成との間に、いくつかの中間的な構成が可能である。
可能性な概念化として、rline - チャネライザ - runit という3層構造があるが、これは不採用とした。
つまり、runit は個々の割り付け方式と独立した概念とし、runitとチャネライザとの対応関係はrunitの属性として管理する方が、使いやすいと考えた。
実際には「中間的な割り付け」は可能な限り避けることになるはずで、そのような可能性のためにリソースの概念を複雑化するのを嫌った、ということでもある。

| ポート番号 | 受信LO番号 | MxFEの番号 | ADC番号, CNCO番号, FNCO番号 | (group, rline, runit)　 | キャプチャモジュール | キャプチャユニット |
|----|---|---|---------|------------------------|----|---|
| 0  | 0 | 0 | 3, 3, 5 | (0, r, 0)              | 1  | 4 |
| 0  | 0 | 0 | 3, 3, 5 | (0, r, 1)              | 1  | 5 |
| 0  | 0 | 0 | 3, 3, 5 | (0, r, 2)              | 1  | 6 |
| 0  | 0 | 0 | 3, 3, 5 | (0, r, 3)              | 1  | 7 |
| 5  | 1 | 0 | 2, 2, 4 | (0, m, 0)              | 1  | 4 |
| 5  | 1 | 0 | 2, 2, 4 | (0, m, 1)              | 1  | 5 |
| 5  | 1 | 0 | 2, 2, 4 | (0, m, 2)              | 1  | 6 |
| 5  | 1 | 0 | 2, 2, 4 | (0, m, 3)              | 1  | 7 |
| 7  | 7 | 1 | 3, 3, 5 | (0, r, 0)              | 0  | 0 |
| 7  | 7 | 1 | 3, 3, 5 | (0, r, 1)              | 0  | 1 |
| 7  | 7 | 1 | 3, 3, 5 | (0, r, 2)              | 0  | 2 |
| 7  | 7 | 1 | 3, 3, 5 | (0, r, 3)              | 0  | 3 |
| 12 | 6 | 1 | 2, 2, 4 | (0, m, 0)              | 0  | 0 |
| 12 | 6 | 1 | 2, 2, 4 | (0, m, 1)              | 0  | 1 |
| 12 | 6 | 1 | 2, 2, 4 | (0, m, 2)              | 0  | 2 |
| 12 | 6 | 1 | 2, 2, 4 | (0, m, 3)              | 0  | 3 |

#### feedbackファームウェアの場合（対応未完了）
試作版の影響が予定されているfeedback版のファームウェアでは、リード系とモニタ系を同時に使用できる。
これは、モニタ系専用のキャプチャモジュール(2と3)が追加されたことに依る。
これらの新しいキャプチャモジュールは生の波形を監視する目的を満たすべく、DSP機能がないキャプチャユニットがひとつだけから成る。

| ポート番号 | 受信LO番号 | MxFEの番号 | ADC番号, CNCO番号, FNCO番号 | (group, rline, runit)　 | キャプチャモジュール | キャプチャユニット |
|----|---|---------|----------|------------------------|----|----|
| 0  | 0 | 0       | 3, 3, 5  | (0, r, 0)              | 1  | 4  |
| 0  | 0 | 0       | 3, 3, 5  | (0, r, 1)              | 1  | 5  |
| 0  | 0 | 0       | 3, 3, 5  | (0, r, 2)              | 1  | 6  |
| 0  | 0 | 0       | 3, 3, 5  | (0, r, 3)              | 1  | 7  |
| 5  | 1 | 0       | 2, 2, 4  | (0, m, 0)              | 3  | 9  |
| 7  | 7 | 1       | 3, 3, 5  | (1, r, 0)              | 0  | 0  |
| 7  | 7 | 1       | 3, 3, 5  | (1, r, 1)              | 0  | 1  |
| 7  | 7 | 1       | 3, 3, 5  | (1, r, 2)              | 0  | 2  |
| 7  | 7 | 1       | 3, 3, 5  | (1, r, 3)              | 0  | 3  |
| 12 | 6 | 1       | 2, 2, 4  | (1, m, 0)              | 2  | 8  |
