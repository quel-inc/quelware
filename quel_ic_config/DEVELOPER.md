# Developers' Notes

## テスト
近いうちに CI を立ち上げて自動的にテストが走るようになるが、それにしても、手元でテストをしたくなるだろう。
現状、静的解析とユニットテストを用意しており、最低でもこの２つをパスしないコードは`main`へのマージは禁止である。

### 静的解析
```shell
cd sugita_experimental/quel_ic_config
./static_check.sh
```

#### 制御装置などのアドレスについて
コマンドライン引数のバリデータでは ip_address.IPv4Address でチェックをしているが、内部的にはアドレスを str で持っている。
一般的な使用状況では名前で引いて使う可能性などがあるので、IPv4Address型に制限してしまうのは現時点では乱暴だと感じるからである。
一方で、手動テスト時にIPアドレス直打ちで使うことが多いので、引数のバリデータ的で変なアドレスを弾くのは便利だと思う。
ここらへんも、アドレスの持ち方のポリシーを整備してから、実装をまともにしていく予定である。

なお、UDP/IPをハードウェア的に実現している部分があるので、近い将来にIPv6アドレスが使えるようになる、みたいなことは無いはず。

### ユニットテスト
実機を使ったユニットテストよりも大きい粒度のテストも含んでいるが、いずれにしても、全部をPASSする必要がある。

```shell
./unittest device
```

`device` 引数無しで実行すると、実機を使わないテストだけを実行できる。
マージをするためには、`device`付きでの全テスト通過が必須である。
実機テストは、現状、依存ライブラリやハードウェア的な不具合などで落ちることがある。
頻繁に発生する問題は例外などを捉えてリトライするようにしている。
当面は、エラーメッセージを目視で確認して、エラーが装置起因か変更起因かを判断して切り抜けて欲しい（残念）。


## 拡張モジュールのStubの管理
### 取り扱いについて
adi_ad9081_v106 のAPIはユーザには公開しないので、スタブファイルをパッケージに含めない予定。
できる人がリポジトリを参照して叩くのは自由。その場合には、`stubs` 以下にある情報を使って型チェックができるので問題ない。 

### 更新方法
adi_ad9081_v106 の stub は以下で生成したファイルに手で修正を加えて作成している。
```shell
PYTHONPATH=. pybind11-stubgen adi_ad9081_v106 --no-setup-py --root-module-suffix="" --ignore-invalid=all --output-dir="./generated"
```
手修正の差分は、`ref/diff_stub_0` にある。
拡張モジュールに関数やクラスを追加したり、あるいは、既存のもののシグネチャを変更した場合には、上記コマンドでスタブを自動生成し、
差分を `stubs/adi_ad9081_v106/__init__.pyi ` に手で反映するのがよい。
最終的には、`generated/adi_ad9081_v106/__init__.pyi` との差分を取って、当初の差分 `ref/diff_stub_0` と同じになるはずである。
当然ながら、行番号は変わるので、diff出力同士の単純比較はできない。
